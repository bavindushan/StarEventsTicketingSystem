@model IEnumerable<StarEventsTicketingSystem.Models.ApplicationUser>

@{
    ViewData["Title"] = "Manage Users";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 p-4">
            <h2 class="mb-4">Manage Users</h2>

            <!-- Filter by Role -->
            <div class="mb-3">
                <label for="roleFilter" class="form-label">Filter by Role:</label>
                <select id="roleFilter" class="form-select w-auto d-inline-block">
                    <option value="">All Roles</option>
                    @foreach (var role in ViewBag.Roles as List<Microsoft.AspNetCore.Identity.IdentityRole>)
                    {
                        <option value="@role.Name">@role.Name</option>
                    }
                </select>
                <button class="btn btn-primary ms-2" onclick="filterUsers()">Filter</button>
                <button class="btn btn-success ms-3" onclick="openAddAdminModal()">Add Admin</button>
            </div>

            <!-- Users Table -->
            <table class="table table-striped table-bordered" id="usersTable">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    @foreach (var user in Model)
                    {
                        <tr data-user-id="@user.Id" onclick="viewUserDetails('@user.Id')">
                            <td>@user.FullName</td>
                            <td>@user.Email</td>
                            <td>@user.PhoneNumber</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); editUser('@user.Id')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteUser('@user.Id')">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Admin Modal -->
<div class="modal fade" id="addAdminModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("CreateAdmin", "Admin", FormMethod.Post, new { @id = "addAdminForm" }))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Add Admin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="FullName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="Email" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" name="PhoneNumber" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" name="Password" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Admin</button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Edit Admin Modal -->
<div class="modal fade" id="editAdminModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("EditUser", "Admin", FormMethod.Post, new { @id = "editAdminForm" }))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="editUserId" />
                <div class="modal-header">
                    <h5 class="modal-title">Edit Admin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="FullName" id="editFullName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="Email" id="editEmail" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" name="PhoneNumber" id="editPhoneNumber" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select name="Role" id="editRole" class="form-select">
                            @foreach (var role in ViewBag.Roles as List<Microsoft.AspNetCore.Identity.IdentityRole>)
                            {
                                <option value="@role.Name">@role.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password (optional)</label>
                        <input type="password" name="NewPassword" id="editNewPassword" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update</button>
                </div>
            }
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Show SweetAlert messages from TempData
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                    Swal.fire("Success!", "@TempData["SuccessMessage"]", "success");
            </text>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <text>
                    Swal.fire("Error!", "@TempData["ErrorMessage"]", "error");
            </text>
        }

        async function filterUsers() {
            const role = document.getElementById("roleFilter").value;
            const response = await fetch(`/Admin/FilterUsers?role=${role}`);
            const users = await response.json();

            const tbody = document.getElementById("usersBody");
            tbody.innerHTML = "";

            if (users.length > 0) {
                users.forEach(u => {
                    const row = document.createElement("tr");
                    row.setAttribute("data-user-id", u.id);
                    row.onclick = () => viewUserDetails(u.id);
                    row.innerHTML = `
                        <td>${u.fullName}</td>
                        <td>${u.email}</td>
                        <td>${u.phoneNumber}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); editUser('${u.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteUser('${u.id}')">Delete</button>
                        </td>`;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No users found.</td></tr>`;
            }
        }

        function openAddAdminModal() {
            const modal = new bootstrap.Modal(document.getElementById('addAdminModal'));
            modal.show();
        }

                async function editUser(userId) {
            // Fetch user data
            const response = await fetch(`/Admin/GetUser?id=${userId}`);
            if (!response.ok) return;

            const user = await response.json();

            // Populate modal fields
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editFullName').value = user.fullName;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPhoneNumber').value = user.phoneNumber;
            document.getElementById('editRole').value = user.role;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editAdminModal'));
            modal.show();
        }

        function deleteUser(userId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const token = $('input[name="__RequestVerificationToken"]').val(); // Anti-forgery token
                    const response = await fetch(`/Admin/DeleteUser?id=${userId}`, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': token
                        }
                    });

                    const data = await response.json();
                    if (data.success) {
                        Swal.fire('Deleted!', data.message, 'success');
                        // Remove row from table
                        document.querySelector(`tr[data-user-id="${userId}"]`).remove();
                    } else {
                        Swal.fire('Error!', data.message, 'error');
                    }
                }
            });
        }

        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`/Admin/GetUser?id=${userId}`);
                if (!response.ok) {
                    Swal.fire("Error", "Failed to fetch user details.", "error");
                    return;
                }

                const user = await response.json();

                // Example: show details in SweetAlert
                Swal.fire({
                    title: user.fullName,
                    html: `
                        <p><b>Email:</b> ${user.email}</p>
                        <p><b>Phone:</b> ${user.phoneNumber || "N/A"}</p>
                        <p><b>Role:</b> ${user.role}</p>
                        <p><b>Address:</b> ${user.address || "N/A"}</p>
                        <p><b>Created:</b> ${new Date(user.createdAt).toLocaleString()}</p>
                        <p><b>Updated:</b> ${new Date(user.updatedAt).toLocaleString()}</p>
                    `,
                    icon: "info"
                });

            } catch (err) {
                console.error("Error fetching user details:", err);
                Swal.fire("Error", "Something went wrong while fetching user details.", "error");
            }
        }
    </script>
}
